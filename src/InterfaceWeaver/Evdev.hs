module InterfaceWeaver.Evdev (deviceSource, deviceSink) where

import Control.Concurrent (forkIO)
import Control.Exception (SomeException, try)
import Control.Monad (forever, when)
import qualified Data.ByteString.Char8 as BS
import Data.Events (Events)
import qualified Data.Events as Events
import qualified Evdev
import qualified Evdev.Codes as Codes
import qualified Evdev.Uinput as Uinput

deviceSource :: String -> Bool -> IO (Events Evdev.EventData)
deviceSource path grab = do
  eitherDevice <- try $ Evdev.newDevice $ BS.pack path
  case eitherDevice of
    Left (_ :: SomeException) -> do
      fail $ "Could not read device " <> path <> ", maybe try sudo"
    Right device -> do
      when grab $ Evdev.grabDevice device
      (events, push) <- Events.source
      _ <- forkIO $ forever $ do
        (Evdev.Event eventData _) <- Evdev.nextEvent device
        push eventData
      return events

deviceSink :: String -> Events Evdev.EventData -> IO ()
deviceSink name events = do
  virtDev <- virtualDevice name
  Events.sink (Uinput.writeEvent virtDev) events

virtualDevice :: String -> IO Uinput.Device
virtualDevice name = do
  eitherDevice <-
    try $
      Uinput.newDevice
        (BS.pack name)
        Uinput.defaultDeviceOpts {Uinput.keys = allKeys}
  case eitherDevice of
    Left (_ :: SomeException) -> do
      fail $ "Could not create device " <> name <> ", maybe try sudo"
    Right device -> do
      return device

allKeys :: [Codes.Key]
allKeys =
  [ Codes.KeyReserved,
    Codes.KeyEsc,
    Codes.Key1,
    Codes.Key2,
    Codes.Key3,
    Codes.Key4,
    Codes.Key5,
    Codes.Key6,
    Codes.Key7,
    Codes.Key8,
    Codes.Key9,
    Codes.Key0,
    Codes.KeyMinus,
    Codes.KeyEqual,
    Codes.KeyBackspace,
    Codes.KeyTab,
    Codes.KeyQ,
    Codes.KeyW,
    Codes.KeyE,
    Codes.KeyR,
    Codes.KeyT,
    Codes.KeyY,
    Codes.KeyU,
    Codes.KeyI,
    Codes.KeyO,
    Codes.KeyP,
    Codes.KeyLeftbrace,
    Codes.KeyRightbrace,
    Codes.KeyEnter,
    Codes.KeyLeftctrl,
    Codes.KeyA,
    Codes.KeyS,
    Codes.KeyD,
    Codes.KeyF,
    Codes.KeyG,
    Codes.KeyH,
    Codes.KeyJ,
    Codes.KeyK,
    Codes.KeyL,
    Codes.KeySemicolon,
    Codes.KeyApostrophe,
    Codes.KeyGrave,
    Codes.KeyLeftshift,
    Codes.KeyBackslash,
    Codes.KeyZ,
    Codes.KeyX,
    Codes.KeyC,
    Codes.KeyV,
    Codes.KeyB,
    Codes.KeyN,
    Codes.KeyM,
    Codes.KeyComma,
    Codes.KeyDot,
    Codes.KeySlash,
    Codes.KeyRightshift,
    Codes.KeyKpasterisk,
    Codes.KeyLeftalt,
    Codes.KeySpace,
    Codes.KeyCapslock,
    Codes.KeyF1,
    Codes.KeyF2,
    Codes.KeyF3,
    Codes.KeyF4,
    Codes.KeyF5,
    Codes.KeyF6,
    Codes.KeyF7,
    Codes.KeyF8,
    Codes.KeyF9,
    Codes.KeyF10,
    Codes.KeyNumlock,
    Codes.KeyScrolllock,
    Codes.KeyKp7,
    Codes.KeyKp8,
    Codes.KeyKp9,
    Codes.KeyKpminus,
    Codes.KeyKp4,
    Codes.KeyKp5,
    Codes.KeyKp6,
    Codes.KeyKpplus,
    Codes.KeyKp1,
    Codes.KeyKp2,
    Codes.KeyKp3,
    Codes.KeyKp0,
    Codes.KeyKpdot,
    Codes.KeyZenkakuhankaku,
    Codes.Key102nd,
    Codes.KeyF11,
    Codes.KeyF12,
    Codes.KeyRo,
    Codes.KeyKatakana,
    Codes.KeyHiragana,
    Codes.KeyHenkan,
    Codes.KeyKatakanahiragana,
    Codes.KeyMuhenkan,
    Codes.KeyKpjpcomma,
    Codes.KeyKpenter,
    Codes.KeyRightctrl,
    Codes.KeyKpslash,
    Codes.KeySysrq,
    Codes.KeyRightalt,
    Codes.KeyLinefeed,
    Codes.KeyHome,
    Codes.KeyUp,
    Codes.KeyPageup,
    Codes.KeyLeft,
    Codes.KeyRight,
    Codes.KeyEnd,
    Codes.KeyDown,
    Codes.KeyPagedown,
    Codes.KeyInsert,
    Codes.KeyDelete,
    Codes.KeyMacro,
    Codes.KeyMute,
    Codes.KeyVolumedown,
    Codes.KeyVolumeup,
    Codes.KeyPower,
    Codes.KeyKpequal,
    Codes.KeyKpplusminus,
    Codes.KeyPause,
    Codes.KeyScale,
    Codes.KeyKpcomma,
    Codes.KeyHangeul,
    Codes.KeyHanja,
    Codes.KeyYen,
    Codes.KeyLeftmeta,
    Codes.KeyRightmeta,
    Codes.KeyCompose,
    Codes.KeyStop,
    Codes.KeyAgain,
    Codes.KeyProps,
    Codes.KeyUndo,
    Codes.KeyFront,
    Codes.KeyCopy,
    Codes.KeyOpen,
    Codes.KeyPaste,
    Codes.KeyFind,
    Codes.KeyCut,
    Codes.KeyHelp,
    Codes.KeyMenu,
    Codes.KeyCalc,
    Codes.KeySetup,
    Codes.KeySleep,
    Codes.KeyWakeup,
    Codes.KeyFile,
    Codes.KeySendfile,
    Codes.KeyDeletefile,
    Codes.KeyXfer,
    Codes.KeyProg1,
    Codes.KeyProg2,
    Codes.KeyWww,
    Codes.KeyMsdos,
    Codes.KeyScreenlock,
    Codes.KeyRotateDisplay,
    Codes.KeyCyclewindows,
    Codes.KeyMail,
    Codes.KeyBookmarks,
    Codes.KeyComputer,
    Codes.KeyBack,
    Codes.KeyForward,
    Codes.KeyClosecd,
    Codes.KeyEjectcd,
    Codes.KeyEjectclosecd,
    Codes.KeyNextsong,
    Codes.KeyPlaypause,
    Codes.KeyPrevioussong,
    Codes.KeyStopcd,
    Codes.KeyRecord,
    Codes.KeyRewind,
    Codes.KeyPhone,
    Codes.KeyIso,
    Codes.KeyConfig,
    Codes.KeyHomepage,
    Codes.KeyRefresh,
    Codes.KeyExit,
    Codes.KeyMove,
    Codes.KeyEdit,
    Codes.KeyScrollup,
    Codes.KeyScrolldown,
    Codes.KeyKpleftparen,
    Codes.KeyKprightparen,
    Codes.KeyNew,
    Codes.KeyRedo,
    Codes.KeyF13,
    Codes.KeyF14,
    Codes.KeyF15,
    Codes.KeyF16,
    Codes.KeyF17,
    Codes.KeyF18,
    Codes.KeyF19,
    Codes.KeyF20,
    Codes.KeyF21,
    Codes.KeyF22,
    Codes.KeyF23,
    Codes.KeyF24,
    Codes.KeyPlaycd,
    Codes.KeyPausecd,
    Codes.KeyProg3,
    Codes.KeyProg4,
    Codes.KeyDashboard,
    Codes.KeySuspend,
    Codes.KeyClose,
    Codes.KeyPlay,
    Codes.KeyFastforward,
    Codes.KeyBassboost,
    Codes.KeyPrint,
    Codes.KeyHp,
    Codes.KeyCamera,
    Codes.KeySound,
    Codes.KeyQuestion,
    Codes.KeyEmail,
    Codes.KeyChat,
    Codes.KeySearch,
    Codes.KeyConnect,
    Codes.KeyFinance,
    Codes.KeySport,
    Codes.KeyShop,
    Codes.KeyAlterase,
    Codes.KeyCancel,
    Codes.KeyBrightnessdown,
    Codes.KeyBrightnessup,
    Codes.KeyMedia,
    Codes.KeySwitchvideomode,
    Codes.KeyKbdillumtoggle,
    Codes.KeyKbdillumdown,
    Codes.KeyKbdillumup,
    Codes.KeySend,
    Codes.KeyReply,
    Codes.KeyForwardmail,
    Codes.KeySave,
    Codes.KeyDocuments,
    Codes.KeyBattery,
    Codes.KeyBluetooth,
    Codes.KeyWlan,
    Codes.KeyUwb,
    Codes.KeyUnknown,
    Codes.KeyVideoNext,
    Codes.KeyVideoPrev,
    Codes.KeyBrightnessCycle,
    Codes.KeyBrightnessAuto,
    Codes.KeyDisplayOff,
    Codes.KeyWwan,
    Codes.KeyRfkill,
    Codes.KeyMicmute,
    Codes.Btn0,
    Codes.Btn1,
    Codes.Btn2,
    Codes.Btn3,
    Codes.Btn4,
    Codes.Btn5,
    Codes.Btn6,
    Codes.Btn7,
    Codes.Btn8,
    Codes.Btn9,
    Codes.BtnLeft,
    Codes.BtnRight,
    Codes.BtnMiddle,
    Codes.BtnSide,
    Codes.BtnExtra,
    Codes.BtnForward,
    Codes.BtnBack,
    Codes.BtnTask,
    Codes.BtnJoystick,
    Codes.BtnThumb,
    Codes.BtnThumb2,
    Codes.BtnTop,
    Codes.BtnTop2,
    Codes.BtnPinkie,
    Codes.BtnBase,
    Codes.BtnBase2,
    Codes.BtnBase3,
    Codes.BtnBase4,
    Codes.BtnBase5,
    Codes.BtnBase6,
    Codes.BtnDead,
    Codes.BtnA,
    Codes.BtnB,
    Codes.BtnC,
    Codes.BtnX,
    Codes.BtnY,
    Codes.BtnZ,
    Codes.BtnTl,
    Codes.BtnTr,
    Codes.BtnTl2,
    Codes.BtnTr2,
    Codes.BtnSelect,
    Codes.BtnStart,
    Codes.BtnMode,
    Codes.BtnThumbl,
    Codes.BtnThumbr,
    Codes.BtnToolPen,
    Codes.BtnToolRubber,
    Codes.BtnToolBrush,
    Codes.BtnToolPencil,
    Codes.BtnToolAirbrush,
    Codes.BtnToolFinger,
    Codes.BtnToolMouse,
    Codes.BtnToolLens,
    Codes.BtnToolQuinttap,
    Codes.BtnTouch,
    Codes.BtnStylus,
    Codes.BtnStylus2,
    Codes.BtnToolDoubletap,
    Codes.BtnToolTripletap,
    Codes.BtnToolQuadtap,
    Codes.BtnGearDown,
    Codes.BtnGearUp,
    Codes.KeyOk,
    Codes.KeySelect,
    Codes.KeyGoto,
    Codes.KeyClear,
    Codes.KeyPower2,
    Codes.KeyOption,
    Codes.KeyInfo,
    Codes.KeyTime,
    Codes.KeyVendor,
    Codes.KeyArchive,
    Codes.KeyProgram,
    Codes.KeyChannel,
    Codes.KeyFavorites,
    Codes.KeyEpg,
    Codes.KeyPvr,
    Codes.KeyMhp,
    Codes.KeyLanguage,
    Codes.KeyTitle,
    Codes.KeySubtitle,
    Codes.KeyAngle,
    Codes.KeyZoom,
    Codes.KeyMode,
    Codes.KeyKeyboard,
    Codes.KeyScreen,
    Codes.KeyPc,
    Codes.KeyTv,
    Codes.KeyTv2,
    Codes.KeyVcr,
    Codes.KeyVcr2,
    Codes.KeySat,
    Codes.KeySat2,
    Codes.KeyCd,
    Codes.KeyTape,
    Codes.KeyRadio,
    Codes.KeyTuner,
    Codes.KeyPlayer,
    Codes.KeyText,
    Codes.KeyDvd,
    Codes.KeyAux,
    Codes.KeyMp3,
    Codes.KeyAudio,
    Codes.KeyVideo,
    Codes.KeyDirectory,
    Codes.KeyList,
    Codes.KeyMemo,
    Codes.KeyCalendar,
    Codes.KeyRed,
    Codes.KeyGreen,
    Codes.KeyYellow,
    Codes.KeyBlue,
    Codes.KeyChannelup,
    Codes.KeyChanneldown,
    Codes.KeyFirst,
    Codes.KeyLast,
    Codes.KeyAb,
    Codes.KeyNext,
    Codes.KeyRestart,
    Codes.KeySlow,
    Codes.KeyShuffle,
    Codes.KeyBreak,
    Codes.KeyPrevious,
    Codes.KeyDigits,
    Codes.KeyTeen,
    Codes.KeyTwen,
    Codes.KeyVideophone,
    Codes.KeyGames,
    Codes.KeyZoomin,
    Codes.KeyZoomout,
    Codes.KeyZoomreset,
    Codes.KeyWordprocessor,
    Codes.KeyEditor,
    Codes.KeySpreadsheet,
    Codes.KeyGraphicseditor,
    Codes.KeyPresentation,
    Codes.KeyDatabase,
    Codes.KeyNews,
    Codes.KeyVoicemail,
    Codes.KeyAddressbook,
    Codes.KeyMessenger,
    Codes.KeyDisplaytoggle,
    Codes.KeySpellcheck,
    Codes.KeyLogoff,
    Codes.KeyDollar,
    Codes.KeyEuro,
    Codes.KeyFrameback,
    Codes.KeyFrameforward,
    Codes.KeyContextMenu,
    Codes.KeyMediaRepeat,
    Codes.Key10channelsup,
    Codes.Key10channelsdown,
    Codes.KeyImages,
    Codes.KeyDelEol,
    Codes.KeyDelEos,
    Codes.KeyInsLine,
    Codes.KeyDelLine,
    Codes.KeyFn,
    Codes.KeyFnEsc,
    Codes.KeyFnF1,
    Codes.KeyFnF2,
    Codes.KeyFnF3,
    Codes.KeyFnF4,
    Codes.KeyFnF5,
    Codes.KeyFnF6,
    Codes.KeyFnF7,
    Codes.KeyFnF8,
    Codes.KeyFnF9,
    Codes.KeyFnF10,
    Codes.KeyFnF11,
    Codes.KeyFnF12,
    Codes.KeyFn1,
    Codes.KeyFn2,
    Codes.KeyFnD,
    Codes.KeyFnE,
    Codes.KeyFnF,
    Codes.KeyFnS,
    Codes.KeyFnB,
    Codes.KeyBrlDot1,
    Codes.KeyBrlDot2,
    Codes.KeyBrlDot3,
    Codes.KeyBrlDot4,
    Codes.KeyBrlDot5,
    Codes.KeyBrlDot6,
    Codes.KeyBrlDot7,
    Codes.KeyBrlDot8,
    Codes.KeyBrlDot9,
    Codes.KeyBrlDot10,
    Codes.KeyNumeric0,
    Codes.KeyNumeric1,
    Codes.KeyNumeric2,
    Codes.KeyNumeric3,
    Codes.KeyNumeric4,
    Codes.KeyNumeric5,
    Codes.KeyNumeric6,
    Codes.KeyNumeric7,
    Codes.KeyNumeric8,
    Codes.KeyNumeric9,
    Codes.KeyNumericStar,
    Codes.KeyNumericPound,
    Codes.KeyNumericA,
    Codes.KeyNumericB,
    Codes.KeyNumericC,
    Codes.KeyNumericD,
    Codes.KeyCameraFocus,
    Codes.KeyWpsButton,
    Codes.KeyTouchpadToggle,
    Codes.KeyTouchpadOn,
    Codes.KeyTouchpadOff,
    Codes.KeyCameraZoomin,
    Codes.KeyCameraZoomout,
    Codes.KeyCameraUp,
    Codes.KeyCameraDown,
    Codes.KeyCameraLeft,
    Codes.KeyCameraRight,
    Codes.KeyAttendantOn,
    Codes.KeyAttendantOff,
    Codes.KeyAttendantToggle,
    Codes.KeyLightsToggle,
    Codes.BtnDpadUp,
    Codes.BtnDpadDown,
    Codes.BtnDpadLeft,
    Codes.BtnDpadRight,
    Codes.KeyAlsToggle,
    Codes.KeyButtonconfig,
    Codes.KeyTaskmanager,
    Codes.KeyJournal,
    Codes.KeyControlpanel,
    Codes.KeyAppselect,
    Codes.KeyScreensaver,
    Codes.KeyVoicecommand,
    Codes.KeyBrightnessMin,
    Codes.KeyBrightnessMax,
    Codes.KeyKbdinputassistPrev,
    Codes.KeyKbdinputassistNext,
    Codes.KeyKbdinputassistPrevgroup,
    Codes.KeyKbdinputassistNextgroup,
    Codes.KeyKbdinputassistAccept,
    Codes.KeyKbdinputassistCancel,
    Codes.BtnTriggerHappy1,
    Codes.BtnTriggerHappy2,
    Codes.BtnTriggerHappy3,
    Codes.BtnTriggerHappy4,
    Codes.BtnTriggerHappy5,
    Codes.BtnTriggerHappy6,
    Codes.BtnTriggerHappy7,
    Codes.BtnTriggerHappy8,
    Codes.BtnTriggerHappy9,
    Codes.BtnTriggerHappy10,
    Codes.BtnTriggerHappy11,
    Codes.BtnTriggerHappy12,
    Codes.BtnTriggerHappy13,
    Codes.BtnTriggerHappy14,
    Codes.BtnTriggerHappy15,
    Codes.BtnTriggerHappy16,
    Codes.BtnTriggerHappy17,
    Codes.BtnTriggerHappy18,
    Codes.BtnTriggerHappy19,
    Codes.BtnTriggerHappy20,
    Codes.BtnTriggerHappy21,
    Codes.BtnTriggerHappy22,
    Codes.BtnTriggerHappy23,
    Codes.BtnTriggerHappy24,
    Codes.BtnTriggerHappy25,
    Codes.BtnTriggerHappy26,
    Codes.BtnTriggerHappy27,
    Codes.BtnTriggerHappy28,
    Codes.BtnTriggerHappy29,
    Codes.BtnTriggerHappy30,
    Codes.BtnTriggerHappy31,
    Codes.BtnTriggerHappy32,
    Codes.BtnTriggerHappy33,
    Codes.BtnTriggerHappy34,
    Codes.BtnTriggerHappy35,
    Codes.BtnTriggerHappy36,
    Codes.BtnTriggerHappy37,
    Codes.BtnTriggerHappy38,
    Codes.BtnTriggerHappy39,
    Codes.BtnTriggerHappy40
  ]
